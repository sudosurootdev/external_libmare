<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2010-2013 Qualcomm Technologies, Inc. All rights reserved. 
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 header.html - Header file used to customize the headers on each HTML page for the API 
               Interface Specification documents.
 Updated:  03/08/13 LB Updated to support Doxygen 1.8.3.1.
 Updated:  10/25/12 LB Added company name changes.
 New file: 10/15/12 LB Created to support Rev E Alpha process using Doxygen 1.8.2 -->
<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"></meta>
<meta http-equiv="X-UA-Compatible" content="IE=9"></meta>
<title>Multicore Asynchronous Runtime Environment Interoperability</title><!--END !PROJECT_NAME-->
<link href="tabs.css" rel="stylesheet" type="text/css"></link>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="autoEnterCurrentDate.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="is.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Multicore Asynchronous Runtime Environment
   &#160;<span id="projectnumber">HT80-NG608-1 E</span>
   </div>
  </td>
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1-QCOM -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="revision_history.html"><span>Revision&#160;History</span></a></li>
      <li><a href="introduction.html"><span>Introduction</span></a></li>
      <li><a href="usergroup0.html"><span>Getting&#160;Started</span></a></li>
      <li><a href="usergroup1.html"><span>User&#160;Guide</span></a></li>
      <li><a href="usergroup3.html"><span>Tutorials</span></a></li>
      <li><a href="usergroup4.html"><span>Reference&#160;Manual</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('issues.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Interoperability </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="Issues"></a></p>
<p>The MARE programming model isolates programmers from threads; however, MARE applications are multithreaded. In this section we discuss some of the interoperability issues that arise from using threads in the MARE runtime. A MARE application starts in a main thread and may create other threads. In addition, <code><a class="el" href="group__init__shutdown.html#gac85658f566f4b5b1f17b9d81fe14a508">mare::runtime::init()</a></code> creates a thread pool that executes MARE tasks. A MARE task might be created in any thread, and other operations, such as launching and executing on any other threads. While any thread in the application can call <code><a class="el" href="group__tasks__creation.html#ga4d2a57c19a9199c7ccee7a01ff688da8">mare::create_task()</a></code> and <code><a class="el" href="group__sdf__doc.html#gaf6d88ec9965da7eaa9da60ab7c27041b">mare::launch()</a></code>, only a thread from MARE's thread pool can execute a MARE task. The only guarantees regarding which threads a task is executing are defined below.</p>
<h1><a class="anchor" id="safe_points"></a>
Safe Points</h1>
<p>Safe points are MARE API methods where the following property holds: the thread on which the task executes before the API call might not be the same as the thread on which the task executes after the API call.</p>
<p>Following is a comprehensive list of the safe points in the current MARE relase:</p>
<ul>
<li><code>mare::wait_for(mare::task_ptr)</code></li>
<li><code>mare::wait_for(mare::unsafe_task_ptr)</code></li>
<li><code>mare::wait_for(mare::group_ptr)</code></li>
</ul>
<h1><a class="anchor" id="mare_fork"></a>
Using MARE with the Fork() System Call</h1>
<p>The Unix <code>fork()</code> system call is designed to duplicate the current process as a new process. This call is commonly used within shells to start new commands, within web servers to handle new connections in a separate process, and within web browsers to implement security between different browser tabs.</p>
<p>An important limitation of <code>fork()</code> is that it copies the memory of the process, but starts the child with only one thread, cloned from the thread that made the fork() system call. This is a known problem for multithreaded programs, and MARE is no exception. Calling <code>fork()</code> from a task running in the thread pool starts the new process with only one thread from the pool, and no other threads would exist. Tasks running on the other threads would be copied in an inconsistent state, and the output would be indeterminate. MARE implements various features to prevent this misuse of <code>fork()</code>.</p>
<p>No calls to <code>fork()</code> are allowed after <code><a class="el" href="group__init__shutdown.html#gac85658f566f4b5b1f17b9d81fe14a508">mare::runtime::init()</a></code> is called and before <code><a class="el" href="group__init__shutdown.html#ga9876b6a82a27555a8f3affe7f7aa8c4c">mare::runtime::shutdown()</a></code> is invoked. MARE generates a runtime error message in this situation. Once <code><a class="el" href="group__init__shutdown.html#ga9876b6a82a27555a8f3affe7f7aa8c4c">mare::runtime::shutdown()</a></code> is called, the thread pool is destroyed and <code>fork()</code> can be called after this point &mdash; assuming that the application does not have threads other than MARE's. If the application requires using <code>fork()</code>, it should be called either before <code><a class="el" href="group__init__shutdown.html#gac85658f566f4b5b1f17b9d81fe14a508">mare::runtime::init()</a></code> or after <code><a class="el" href="group__init__shutdown.html#ga9876b6a82a27555a8f3affe7f7aa8c4c">mare::runtime::shutdown()</a></code>, and attention should be paid to the use of other threads in the application.</p>
<h1><a class="anchor" id="mare_and_tls"></a>
Using MARE with TLS-aware Libraries</h1>
<p>There are other libraries, such as libraries that use Thread Local Storage (TLS) that also interact with the MARE runtime in non-intuitive ways. Remember that when MARE tasks execute, they stay on the same thread until they complete execution or they arrive at a safe point. In most cases this is not a problem; however, when a task makes calls to libraries that use TLS, there are a number of issues that we discuss below.</p>
<p>Following are examples of common TLS-aware libraries:</p>
<dl class="section user"><dt>Xlib</dt><dd>The Xlib libraries are typically not thread-safe, although each implementation is different. It is not possible to perform display operations from two threads at the same time because this could corrupt internal data structures. While multiple threads can be used, the programmer must ensure that only one thread can be using Xlib at any time.</dd></dl>
<dl class="section user"><dt>UI Toolkits</dt><dd>User interface toolkits &mdash;such as QT&mdash; typically have a main thread which is dedicated to processing input events, manipulating a display, and then sleeping until more input occurs. It is important that control is returned to the UI toolkit as soon as possible to ensure that the user experience is smooth and uninterrupted. If a call from a different thread is made to a function that manipulates the UI or triggers an event, the toolkit may corrupt a data structure, or detect this and generate an error message.</dd></dl>
<dl class="section user"><dt>OpenGL </dt><dd>Each OpenGL implementation varies in how it can be used with multiple threads. In typical usage, you create an OpenGL context in the thread where you intend to use it. The OpenGL library then sets internal state information into TLS. This internal state is used so that when calls are made to OpenGL, you do not need to pass the context around each time. However, the TLS is set for only one thread. So if you try to make an OpenGL call from a different thread, the implementation may fail. Some implementations allow multiple contexts, with each context being created on the thread where it will be used. With multiple contexts, some implementations also allow parallel access to the OpenGL library, although this support varies depending on the vendor. Hardware implementing OpenGL typically uses some kind of command buffer, which can force a sequential ordering of commands. Therefore, trying to implement calls to OpenGL in parallel may not provide any benefit, and may actually slow things down due to contention on the mutex used to protect the command buffer. An OpenGL application is typically used with some kind of user interface and event handler, which will be running on the main thread. So it is recommended that you perform your OpenGL calls in the same thread as the user interface.</dd></dl>
<p>While these are limitations that need to be taken into consideration, it is still possible to exploit parallelism using MARE in these types of applications. For example, let us consider the case of a game with physics simulation, where the user can click on the display to launch spheres into a room. In a nonparallel implementation, the user touches the display, which generates a UI event. The UI thread wakes up and processes the UI event, which needs to generate the new sphere in the physics simulation. The physics simulation runs for the time required to compute the result. The location of all objects in the physics simulation is then traversed, and OpenGL calls are made to draw the scene. The OpenGL buffers are then swapped onto the display, and the thread goes back to sleep to wait for either a UI event, or a timeout to refresh the display with no change.</p>
<p>When analyzing the previous example, the bulk of the calculations are performed in the physics engine. This is very computationally expensive and where the most optimizational work can be applied. So MARE can be used here to perform the computation in parallel, assuming the underlying implementation supports this. The user breaks down the parts of the simulation into a suitable number of tasks, specifies dependencies, and then launches them with MARE. When the tasks are launched, the thread does a <code><a class="el" href="group__groups__waiting.html#gaa2a0ab6d7f24ae0840b581bfa8e94fea">wait_for()</a></code> until the tasks have completed. In the meantime, the thread pool begins executing the tasks, which spreads the computational load across all available processors. When the tasks are done, the <code><a class="el" href="group__groups__waiting.html#gaa2a0ab6d7f24ae0840b581bfa8e94fea">wait_for()</a></code> will return, and execution on the main thread can continue with the calls to OpenGL for rendering. With this arrangement, you can see that the operations that are thread-sensitive are performed in one thread, guaranteeing safe use of libraries such as OpenGL and the user interface toolkit. Many computationally intensive OpenGL applications are written with an event loop very similar to that described above, so these changes should be relatively simple to implement to take advantage of MARE.</p>
<h1><a class="anchor" id="jemalloc"></a>
Scaling Memory Allocation Performance</h1>
<p>The scalability of the default memory allocator for your system can have a profound effect on the scalability of a MARE application. The developers have experimented with several publically available allocators and, at the time of this writing, have identified <a href="http://www.canonware.com/jemalloc/">jemalloc</a> to have the right properties to allow a MARE application for scale well. See your platform documentation on how to interpose this library.</p>
<dl class="section user"><dt>Instructions for Android</dt><dd>The lack of scalability is particularly apparent when using the memory allocator that comes with the <a href="http://developer.android.com/tools/sdk/ndk/index.html">Android NDK</a>. As of Android 4.0, Ice Cream Sandwich, it is possible to run applications with wrappers to identify alternate facilities, such as memory allocators. To use an alternate memory allocator:</dd></dl>
<ol type="1">
<li>copy the memory allocator library to your device</li>
<li>find the process name of your application and set the wrap property:</li>
</ol>
<div class="fragment"><div class="line">PROCNAME=com.app</div>
<div class="line">adb shell setprop wrap.$PROCNAME LD_PRELOAD=/path/jemalloc/jemalloc.so</div>
</div><!-- fragment --><h1><a class="anchor" id="mare_avoid_cout"></a>
Avoid the Use of C++ iostream and stringstream Libraries</h1>
<dl class="section warning"><dt>Warning</dt><dd>The C++11 standard indicates that the iostream library should be thread safe. As of this writing, the developers have experienced stability issues on some platforms, such as Android and OSX. In order to maximize portability, MARE applications should avoid using <code>cout</code> and <code>cerr</code> to perform asynchronous writes, especially to the console. It is recommended to use the C-based <code>stdio printf</code> routines. On Android, the developers have experienced additional issues with <code>stringstream</code> objects. </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  Copyright (c) 2012-2013 Qualcomm Technologies, Inc. All rights reserved. 
  Confidential and Proprietary - Qualcomm Technologies, Inc.
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 footer.html - footer file used to customize the footers on each HTML page for the API 
               Interface Specification documents.
 Updated:  11/05/13 LB Removed confidential, distribution, and export statement.
 Updated:  09/20/13 LB Updated to support mare project's User Guide and API doc.
 Updated:  04/18/13 LB Added Documentation and Interface Specification in place of hard-coding doc dcn. Deleted original
                       use of Documentation and Interface Specification to display text in the left portion of the footer.
 Updated:  03/08/13 LB Updated to support Doxygen 1.8.3.1
 Updated:  01/18/13 LB Replaced qualcomm_logo.gif to QTI_Logo.png
 Updated:  10/25/12 LB Added company name changes.
 New file: 10/15/12 LB Created to support the Rev E Alpha Doxygen-to-HTML-PDF process. -->
<!-- start footer part -->
<!-- 7/12/12 JG added div class defined in css to include warning statement on all pages -->
<!--[if lte IE 8]><div class="warningmsgie8"><![endif]-->
<!--[if(gte IE 9)|!(IE)]><!--><div class="warningmsg"><!--<![endif]-->
</div>
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="userguide.html">User Guide</a></li>
    <li class="footer">
		<p align="right">HT80-NG608-1 E<br />
        <img class="footer"  alt="QTI Logo" src="qti_logo_HTML.png" />
		</p>
		</li>
  </ul>
</div>
</body>
</html>
